<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>État des lieux {{ etat_lieux.get_type_etat_lieux_display }}</title>
    <style>
        @page {
            margin: 2cm;
            size: A4;
        }
        
        body {
            font-family: 'Times New Roman', 'Arial', serif;
            font-size: 12pt;
            color: #3e3c41;
            background-color: #ffffff;
            line-height: 1.6em;
        }
        
        h1, h2, h3 {
            color: #4a6b85;
            margin-top: 2em;
        }
        
        .document-title {
            text-align: center;
            font-size: 20pt;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 0.2cm;
            color: #4a6b85;
        }
        
        .document-subtitle {
            text-align: center;
            font-size: 12pt;
            font-style: italic;
            margin-bottom: 2cm;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4a6b85;
            padding-bottom: 20px;
        }
        
        .header h1 {
            font-size: 20pt;
            margin-bottom: 10px;
            color: #4a6b85;
            font-weight: bold;
        }
        
        .bien-info {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #4a6b85;
            border-left: 4px solid #4a6b85;
        }
        
        .bien-info h2 {
            margin-top: 0;
            font-size: 16pt;
            color: #4a6b85;
            font-weight: bold;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            margin-bottom: 0.5em;
            line-height: 1.6em;
        }
        
        .info-label {
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
        
        .piece {
            margin-bottom: 30px;
            border: 1px solid #4a6b85;
            page-break-inside: avoid;
        }
        
        .piece-header {
            background-color: #4a6b85;
            color: white;
            padding: 10px;
            font-weight: bold;
            font-size: 14pt;
        }
        
        .piece-content {
            padding: 15px;
        }
        
        .elements-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .elements-table th,
        .elements-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            line-height: 1.6em;
        }
        
        .elements-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #4a6b85;
        }
        
        .state-excellent { background-color: #d4edda; }
        .state-good { background-color: #d1ecf1; }
        .state-fair { background-color: #ffeaa7; }
        .state-poor { background-color: #f8d7da; }
        .state-empty { background-color: #f8f9fa; }
        
        .equipment-section {
            margin-top: 20px;
        }
        
        .equipment-section h4 {
            color: #4a6b85;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .equipment-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        
        .equipment-item {
            background-color: #f8f9fa;
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid #4a6b85;
            line-height: 1.6em;
        }
        
        .signature-section {
            margin-top: 40px;
            page-break-before: always;
            margin-bottom: 0;
        }
        
        .signature-section h2 {
            color: #4a6b85;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .signature {
            margin-top: 0;
        }
        
        .signature-list {
            display: block;
        }
        
        .signature-block {
            width: 45%;
            text-align: left;
            margin-bottom: 40px;
            min-height: 182px;
            border-bottom: 1px dotted #999;
        }
        
        .signature h4 {
            color: #4a6b85;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .date-field {
            margin-top: 20px;
            font-size: 11pt;
            color: #4a6b85;
        }
        
        .comments-section {
            margin-top: 20px;
            min-height: 80px;
            border: 2px solid #4a6b85;
            padding: 15px;
            background-color: #f8f9fa;
        }
        
        .comments-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #4a6b85;
        }
        
        .photos-section {
            margin-top: 15px;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-item {
            border: 1px solid #4a6b85;
            padding: 8px;
            text-align: center;
            background-color: #f8f9fa;
        }
        
        .photo-image {
            max-width: 100%;
            max-height: 120px;
            width: auto;
            height: auto;
        }
        
        .photo-caption {
            font-size: 10pt;
            color: #4a6b85;
            margin-top: 5px;
            font-style: italic;
        }
        
        .element-photos {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 3px solid #4a6b85;
        }
        
        .element-photos h5 {
            color: #4a6b85;
            margin-bottom: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- En-tête du document -->
    <div class="header">
        <h1>{{ etat_lieux.get_type_etat_lieux_display }}</h1>
        <p style="text-align: center; margin-top: 10px; font-size: 14pt; color: #4a6b85;">
            {% if etat_lieux.type_etat_lieux == "entree" %}
                Date d'entrée : {{ etat_lieux.bail.date_etat_lieux_entree|date:"d F Y"|default:"Non renseignée" }}
            {% else %}
                Date de sortie : {{ etat_lieux.bail.date_fin|date:"d F Y"|default:"Non renseignée" }}
            {% endif %}
        </p>
    </div>

    <!-- Informations du bien -->
    <div class="bien-info">
        <h2>Informations du bien</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Adresse :</span>
                {{ etat_lieux.bail.bien.adresse }}
            </div>
            <div class="info-item">
                <span class="info-label">Type :</span>
                {{ etat_lieux.bail.bien.get_type_bien_display }}
            </div>
            <div class="info-item">
                <span class="info-label">Superficie :</span>
                {{ etat_lieux.bail.bien.superficie }} m²
            </div>
            <div class="info-item">
                <span class="info-label">Meublé :</span>
                {% if etat_lieux.bail.bien.meuble %}Oui{% else %}Non{% endif %}
            </div>
        </div>
    </div>

    <!-- Informations complémentaires -->
    {% if etat_lieux.nombre_cles %}
    <div class="bien-info">
        <h2>Clés remises</h2>
        <div class="info-grid">
            <table style="width: 100%; border-collapse: collapse;">
                <tbody>
                    {% if etat_lieux.nombre_cles.immeuble and etat_lieux.nombre_cles.immeuble.count > 0 %}
                    <tr>
                        <td style="padding: 5px 8px; width: 200px;">Immeuble :</td>
                        <td style="padding: 5px 8px;">{{ etat_lieux.nombre_cles.immeuble.count }} clé{% if etat_lieux.nombre_cles.immeuble.count > 1 %}s{% endif %}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.nombre_cles.entree and etat_lieux.nombre_cles.entree.count > 0 %}
                    <tr>
                        <td style="padding: 5px 8px; width: 200px;">Entrée :</td>
                        <td style="padding: 5px 8px;">{{ etat_lieux.nombre_cles.entree.count }} clé{% if etat_lieux.nombre_cles.entree.count > 1 %}s{% endif %}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.nombre_cles.boiteAuxLettres and etat_lieux.nombre_cles.boiteAuxLettres.count > 0 %}
                    <tr>
                        <td style="padding: 5px 8px; width: 200px;">Boîte aux lettres :</td>
                        <td style="padding: 5px 8px;">{{ etat_lieux.nombre_cles.boiteAuxLettres.count }} clé{% if etat_lieux.nombre_cles.boiteAuxLettres.count > 1 %}s{% endif %}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.nombre_cles.cave and etat_lieux.nombre_cles.cave.count > 0 %}
                    <tr>
                        <td style="padding: 5px 8px; width: 200px;">Cave :</td>
                        <td style="padding: 5px 8px;">{{ etat_lieux.nombre_cles.cave.count }} clé{% if etat_lieux.nombre_cles.cave.count > 1 %}s{% endif %}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.nombre_cles.portail and etat_lieux.nombre_cles.portail.count > 0 %}
                    <tr>
                        <td style="padding: 5px 8px; width: 200px;">Portail :</td>
                        <td style="padding: 5px 8px;">{{ etat_lieux.nombre_cles.portail.count }} clé{% if etat_lieux.nombre_cles.portail.count > 1 %}s{% endif %}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.nombre_cles.parking and etat_lieux.nombre_cles.parking.count > 0 %}
                    <tr>
                        <td style="padding: 5px 8px; width: 200px;">Parking :</td>
                        <td style="padding: 5px 8px;">{{ etat_lieux.nombre_cles.parking.count }} clé{% if etat_lieux.nombre_cles.parking.count > 1 %}s{% endif %}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if etat_lieux.bail.bien.chauffage_energie or etat_lieux.bail.bien.eau_chaude_energie or etat_lieux.equipements_chauffage %}
    <div class="bien-info">
        <h2>Chauffage et eau chaude</h2>
        <div class="info-grid">
            {% if etat_lieux.bail.bien.chauffage_energie %}
            <div class="info-row" style="margin-bottom: 20px;">
                <div style="margin-bottom: 8px;">
                    <span class="info-label" style="font-weight: bold; display: inline-block; min-width: 150px;">Chauffage :</span>
                    <span style="text-transform: capitalize;">{{ etat_lieux.bail.bien.chauffage_energie|default:"Non renseigné" }}</span>
                </div>
                <div style="margin-left: 20px;">
                    <span style="margin-right: 40px;">
                        {% if etat_lieux.bail.bien.chauffage_type == "collectif" %}☑{% else %}☐{% endif %} Collectif
                    </span>
                    <span>
                        {% if etat_lieux.bail.bien.chauffage_type == "individuel" %}☑{% else %}☐{% endif %} Individuel
                    </span>
                </div>
            </div>
            {% endif %}
            
            {% if etat_lieux.bail.bien.eau_chaude_energie %}
            <div class="info-row" style="margin-bottom: 20px;">
                <div style="margin-bottom: 8px;">
                    <span class="info-label" style="font-weight: bold; display: inline-block; min-width: 150px;">Eau chaude :</span>
                    <span style="text-transform: capitalize;">{{ etat_lieux.bail.bien.eau_chaude_energie|default:"Non renseigné" }}</span>
                </div>
                <div style="margin-left: 20px;">
                    <span style="margin-right: 40px;">
                        {% if etat_lieux.bail.bien.eau_chaude_type == "collectif" %}☑{% else %}☐{% endif %} Collectif
                    </span>
                    <span>
                        {% if etat_lieux.bail.bien.eau_chaude_type == "individuel" %}☑{% else %}☐{% endif %} Individuel
                    </span>
                </div>
            </div>
            {% endif %}

            {% if etat_lieux.equipements_chauffage %}
                {% if etat_lieux.equipements_chauffage.radiateurs or etat_lieux.equipements_chauffage.chaudiere or etat_lieux.equipements_chauffage.chauffeEau %}
                <div class="info-row" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">Équipements installés :</div>
                    <ul style="margin: 0 0 5px 20px; padding-left: 10px; list-style-type: none;">
                    {% if etat_lieux.equipements_chauffage.radiateurs %}
                        <li style="margin-bottom: 3px;">• Radiateurs : {{ etat_lieux.equipements_chauffage.radiateurs }}</li>
                    {% endif %}
                    {% if etat_lieux.equipements_chauffage.chaudiere %}
                        <li style="margin-bottom: 3px;">• Chaudière : {{ etat_lieux.equipements_chauffage.chaudiere }}</li>
                    {% endif %}
                    {% if etat_lieux.equipements_chauffage.chauffeEau %}
                        <li style="margin-bottom: 3px;">• Chauffe-eau : {{ etat_lieux.equipements_chauffage.chauffeEau }}</li>
                    {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                {% if etat_lieux.equipements_chauffage.equipements %}
                <div class="info-row" style="margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">Autres équipements :</div>
                    <ul style="margin: 0 0 5px 20px; padding-left: 10px; list-style-type: none;">
                    {% for equipement in etat_lieux.equipements_chauffage.equipements %}
                        <li style="margin-bottom: 3px;">• {{ equipement }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if etat_lieux.compteurs %}
    <div class="bien-info">
        <h2>Relevés des compteurs</h2>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="border-bottom: 2px solid #4a6b85;">
                    <th style="text-align: left; padding: 10px 8px; font-weight: bold; width: 25%;">Type</th>
                    <th style="text-align: left; padding: 10px 8px; font-weight: bold; width: 35%;">N° Compteur</th>
                    <th style="text-align: left; padding: 10px 8px; font-weight: bold; width: 40%;">Relevé</th>
                </tr>
            </thead>
                <tbody>
                    {% if etat_lieux.compteurs.electricite %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px; vertical-align: top;">Électricité</td>
                        <td style="padding: 8px; vertical-align: top;">{{ etat_lieux.compteurs.electricite.numero|default:"-" }}</td>
                        <td style="padding: 8px;">
                            {% if etat_lieux.compteurs.electricite.hp or etat_lieux.compteurs.electricite.hc %}
                                {% if etat_lieux.compteurs.electricite.hp %}
                                    <div>Heures pleines : {{ etat_lieux.compteurs.electricite.hp }} kWh</div>
                                {% endif %}
                                {% if etat_lieux.compteurs.electricite.hc %}
                                    <div>Heures creuses : {{ etat_lieux.compteurs.electricite.hc }} kWh</div>
                                {% endif %}
                            {% elif etat_lieux.compteurs.electricite.releve %}
                                {{ etat_lieux.compteurs.electricite.releve }} kWh
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.compteurs.gaz %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px; vertical-align: top;">Gaz</td>
                        <td style="padding: 8px; vertical-align: top;">{{ etat_lieux.compteurs.gaz.numero|default:"-" }}</td>
                        <td style="padding: 8px;">
                            {% if etat_lieux.compteurs.gaz.index %}
                                Index : {{ etat_lieux.compteurs.gaz.index }} m³
                            {% elif etat_lieux.compteurs.gaz.releve %}
                                {{ etat_lieux.compteurs.gaz.releve }} m³
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.compteurs.eau %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px; vertical-align: top;">Eau</td>
                        <td style="padding: 8px; vertical-align: top;">{{ etat_lieux.compteurs.eau.numero|default:"-" }}</td>
                        <td style="padding: 8px;">
                            {% if etat_lieux.compteurs.eau.froide or etat_lieux.compteurs.eau.chaude %}
                                {% if etat_lieux.compteurs.eau.froide %}
                                    <div>Eau froide : {{ etat_lieux.compteurs.eau.froide }} m³</div>
                                {% endif %}
                                {% if etat_lieux.compteurs.eau.chaude %}
                                    <div>Eau chaude : {{ etat_lieux.compteurs.eau.chaude }} m³</div>
                                {% endif %}
                            {% elif etat_lieux.compteurs.eau.releve %}
                                {{ etat_lieux.compteurs.eau.releve }} m³
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.compteurs.fioul %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">Fioul</td>
                        <td style="padding: 8px;">-</td>
                        <td style="padding: 8px;">{{ etat_lieux.compteurs.fioul.releve|default:"-" }}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.compteurs.bois %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">Bois</td>
                        <td style="padding: 8px;">-</td>
                        <td style="padding: 8px;">{{ etat_lieux.compteurs.bois.releve|default:"-" }}</td>
                    </tr>
                    {% endif %}
                    
                    {% if etat_lieux.compteurs.autre %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">Autre</td>
                        <td style="padding: 8px;">-</td>
                        <td style="padding: 8px;">{{ etat_lieux.compteurs.autre.releve|default:"-" }}</td>
                    </tr>
                    {% endif %}
                </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Détail des pièces -->
    {% for piece_data in pieces_enrichies %}
    <div class="piece">
        <div class="piece-header">
            {{ piece_data.piece.nom }}
        </div>
        <div class="piece-content">
            <!-- Table des éléments avec photos -->
            <table class="elements-table">
                <thead>
                    <tr>
                        <th>Élément</th>
                        <th>État</th>
                        <th>Observations</th>
                    </tr>
                </thead>
                <tbody>
                    {% for element in piece_data.elements %}
                    <tr>
                        <td>{{ element.name }}</td>
                        <td class="{{ element.state_css_class }}">
                            {{ element.state_display }}
                        </td>
                        <td>{{ element.comment|default:"-" }}</td>
                    </tr>
                    
                    <!-- Photos pour cet élément -->
                    {% if element.photos %}
                    <tr>
                        <td colspan="3">
                            <div class="element-photos">
                                <h5>Photos - {{ element.name }}</h5>
                                <div class="photos-grid">
                                    {% for photo in element.photos %}
                                    <div class="photo-item">
                                        <img src="{{ photo.data_url }}" alt="{{ photo.nom_original }}" class="photo-image" />
                                        <div class="photo-caption">{{ photo.nom_original }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>

            <!-- Équipements -->
            {% if piece_data.piece.equipments %}
            <div class="equipment-section">
                <h4>Équipements</h4>
                <ul class="equipment-list">
                    {% for equipment in piece_data.piece.equipments %}
                    <li class="equipment-item">
                        {{ equipment.name }} - Quantité: {{ equipment.quantity }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Mobilier (si meublé) -->
            {% if etat_lieux.bail.bien.meuble and piece_data.piece.mobilier %}
            <div class="equipment-section">
                <h4>Mobilier</h4>
                <ul class="equipment-list">
                    {% for mobilier in piece_data.piece.mobilier %}
                    <li class="equipment-item">
                        {{ mobilier.name }} - Quantité: {{ mobilier.quantity }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Section commentaires généraux -->
    <div class="comments-section">
        <div class="comments-title">Observations générales :</div>
        <div style="min-height: 80px;">
            <!-- Espace pour les commentaires généraux -->
        </div>
    </div>

    <!-- Section signatures -->
     <div class="section signature-section">
    <h2>Signatures</h2>
    <div class="signature">
      <!-- Landlord signature blocks -->
      <h4 id="landlord-signature-header">
        {% with count=etat_lieux.bail.bien.bailleurs.all|length %}
          Bailleur{% if count > 1 %}s{% endif %}
        {% endwith %}
      </h4>
      <div class="signature-list">
        {% for bailleur in etat_lieux.bail.bien.bailleurs.all %}
        <div class="signature-block">
          <!-- ID invisible pour PyMuPDF -->
          <p style="color:white; margin: 0;">ID_SIGNATURE_BAILLEUR_{{ bailleur.signataire.id }}</p>
        </div>
        {% endfor %}
      </div>
  
      <!-- Tenant signature blocks -->
      <h4 id="tenant-signature-header">
        {% with count=etat_lieux.bail.locataires.all|length %}
          Locataire{% if count > 1 %}s{% endif %}
        {% endwith %}
      </h4>
      <div class="signature-list">
        {% for person in etat_lieux.bail.locataires.all %}
        <div class="signature-block">
          <!-- ID invisible pour PyMuPDF -->
          <p style="color:white; margin: 0;">ID_SIGNATURE_LOC_{{ person.id }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</body>
</html>
